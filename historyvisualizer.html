<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>maximum effort</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #232f3e;
            color: white;
        }
        #refreshButton {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #3a4a61;
            color: white;
            border: none;
            cursor: pointer;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            background-color: #2e3b4e;
            color: white;
        }
        th, td {
            border: 1px solid #555;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #3a4a61;
            cursor: pointer;
        }
        input[type="text"] {
            margin-top: 20px;
            padding: 5px;
            width: 200px;
            background-color: #2e3b4e;
            color: white;
            border: 1px solid #555;
        }
        tr:nth-child(even) {
            background-color: #2e3b4e;
        }
        tr:nth-child(odd) {
            background-color: #34465d;
        }
        tr:hover {
            background-color: #3a4a61;
        }
    </style>
</head>
<body>

<h1>maximum effort</h1>

<button id="loadDataButton">Load Data</button>
<button id="refreshButton" style="display:none;">Refresh Data</button>
<br>
<input type="text" id="searchInput" placeholder="Search..." style="display:none;">

<table id="lootTable" style="display:none;">
    <thead>
        <tr>
            <th>Player</th>
            <th>Date</th>
            <th>Time</th>
            <th>Item</th>
            <th>Response</th>
            <th>Class</th>
            <th>Instance</th>
            <th>Boss</th>
            <th>Note</th>
        </tr>
    </thead>
    <tbody>
        <!-- Data will be inserted here -->
    </tbody>
</table>

<script>
// Function to parse CSV data
function parseCSV(data) {
    const rows = [];
    let row = [];
    let currentField = '';
    let insideQuotes = false;
    let i = 0;

    while (i < data.length) {
        const char = data[i];

        if (char === '"') {
            if (insideQuotes && data[i + 1] === '"') {
                // Escaped quote
                currentField += '"';
                i++;
            } else {
                insideQuotes = !insideQuotes;
            }
        } else if (char === ',' && !insideQuotes) {
            row.push(currentField);
            currentField = '';
        } else if ((char === '\n' || char === '\r') && !insideQuotes) {
            if (currentField || currentField === '') {
                row.push(currentField);
                currentField = '';
            }
            if (row.length > 0) {
                rows.push(row);
                row = [];
            }
            // Handle \r\n (Windows) line endings
            if (char === '\r' && data[i + 1] === '\n') {
                i++;
            }
        } else {
            currentField += char;
        }
        i++;
    }

    // Add the last field and row if necessary
    if (currentField || currentField === '') {
        row.push(currentField);
    }
    if (row.length > 0) {
        rows.push(row);
    }

    // Convert array of arrays into array of objects
    const headers = rows[0];
    const entries = [];
    for (let j = 1; j < rows.length; j++) {
        const obj = {};
        const currentRow = rows[j];
        headers.forEach((header, index) => {
            obj[header] = currentRow[index] || '';
        });
        entries.push(obj);
    }
    return entries;
}

// Function to create table rows
function createTableRows(data) {
    const tbody = document.querySelector('#lootTable tbody');
    tbody.innerHTML = '';

    data.forEach(entry => {
        const row = document.createElement('tr');

        ['player', 'date', 'time', 'item', 'response', 'class', 'instance', 'boss', 'note'].forEach(key => {
            const cell = document.createElement('td');
            cell.textContent = entry[key] || '';
            row.appendChild(cell);
        });

        tbody.appendChild(row);
    });
}

// Function to sort table
function sortTable(n) {
    const table = document.getElementById("lootTable");
    let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    switching = true;
    dir = "asc";

    while (switching) {
        switching = false;
        rows = table.rows;

        for (i = 1; i < (rows.length - 1); i++) {
            shouldSwitch = false;
            x = rows[i].getElementsByTagName("TD")[n].textContent.toLowerCase();
            y = rows[i + 1].getElementsByTagName("TD")[n].textContent.toLowerCase();

            if (dir === "asc") {
                if (x > y) {
                    shouldSwitch = true;
                    break;
                }
            } else if (dir === "desc") {
                if (x < y) {
                    shouldSwitch = true;
                    break;
                }
            }
        }
        if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
        } else {
            if (switchcount === 0 && dir === "asc") {
                dir = "desc";
                switching = true;
            }
        }
    }
}

// Event listeners for table headers
document.querySelectorAll('#lootTable th').forEach((th, index) => {
    th.addEventListener('click', () => sortTable(index));
});

// Search functionality
document.getElementById('searchInput').addEventListener('keyup', function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#lootTable tbody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
    });
});

// Function to load data from URL
function loadDataFromURL() {
    const dataURL = 'https://raw.githubusercontent.com/afunyun/swloot_history/main/loot_export.csv';

    fetch(dataURL)
        .then(response => response.text())
        .then(contents => {
            const lootData = parseCSV(contents);
            createTableRows(lootData);

            // Show the table and search input
            document.getElementById('lootTable').style.display = '';
            document.getElementById('searchInput').style.display = '';
            document.getElementById('refreshButton').style.display = '';
        })
        .catch(error => {
            console.error('Error fetching the data:', error);
            alert('Failed to load data. Please check the console for details.');
        });
}

// Handle load data button click
document.getElementById('loadDataButton').addEventListener('click', function() {
    loadDataFromURL();
});

// Handle refresh button click
document.getElementById('refreshButton').addEventListener('click', function() {
    loadDataFromURL();
});
</script>

</body>
</html>
